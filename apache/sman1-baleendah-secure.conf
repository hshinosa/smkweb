# ============================================================================
# Apache Configuration for SMAN 1 Baleendah - Production with Cookie Security
# ============================================================================
# Location: /etc/apache2/sites-available/sman1-baleendah.conf
# Enable: sudo a2ensite sman1-baleendah
# Enable modules: sudo a2enmod ssl rewrite headers http2
# Test: sudo apache2ctl configtest
# Reload: sudo systemctl reload apache2
# ============================================================================

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName sman1-baleendah.com
    ServerAlias www.sman1-baleendah.com
    
    # Let's Encrypt ACME challenge
    Alias /.well-known/acme-challenge/ /var/www/certbot/.well-known/acme-challenge/
    <Directory "/var/www/certbot/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>
    
    # Redirect to HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

# HTTPS Server
<VirtualHost *:443>
    ServerName sman1-baleendah.com
    ServerAlias www.sman1-baleendah.com
    ServerAdmin admin@sman1-baleendah.com
    
    DocumentRoot /var/www/sman1-baleendah/public
    
    # ========================================================================
    # SSL/TLS Configuration
    # ========================================================================
    
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/sman1-baleendah.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/sman1-baleendah.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/sman1-baleendah.com/chain.pem
    
    # SSL Protocols (TLS 1.2 and 1.3 only)
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    
    # SSL Ciphers
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    
    # SSL Session Optimization
    SSLSessionTickets off
    SSLUseStapling on
    SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"
    
    # ========================================================================
    # Security Headers
    # ========================================================================
    
    <IfModule mod_headers.c>
        # HTTP Strict Transport Security (HSTS)
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Content Security Policy
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"
        
        # XSS Protection
        Header always set X-XSS-Protection "1; mode=block"
        
        # Clickjacking Protection
        Header always set X-Frame-Options "SAMEORIGIN"
        
        # MIME Type Sniffing Protection
        Header always set X-Content-Type-Options "nosniff"
        
        # Referrer Policy
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        
        # Permissions Policy
        Header always set Permissions-Policy "geolocation=(self), microphone=(), camera=()"
        
        # Remove Server Header
        Header always unset Server
        Header always unset X-Powered-By
        
        # ====================================================================
        # Cookie Security Headers (Backup Layer)
        # ====================================================================
        # Note: Primary cookie security is handled by Laravel
        
        # Add security attributes to all cookies
        Header edit Set-Cookie ^(.*)$ "$1; Secure; HttpOnly; SameSite=Lax"
        
        # Remove HttpOnly from XSRF-TOKEN (must be readable by JavaScript)
        Header edit Set-Cookie "^(XSRF-TOKEN=.*)HttpOnly" "$1"
        
        # ====================================================================
        # Cache Control for Static Assets
        # ====================================================================
        <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
    </IfModule>
    
    # ========================================================================
    # Directory Configuration
    # ========================================================================
    
    <Directory /var/www/sman1-baleendah/public>
        Options -Indexes +FollowSymLinks -MultiViews
        AllowOverride All
        Require all granted
        
        # ====================================================================
        # URL Rewriting for Laravel
        # ====================================================================
        <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # Handle Authorization Header
            RewriteCond %{HTTP:Authorization} .
            RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
            
            # Redirect Trailing Slashes If Not A Folder
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_URI} (.+)/$
            RewriteRule ^ %1 [L,R=301]
            
            # Send Requests To Front Controller
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^ index.php [L]
        </IfModule>
    </Directory>
    
    # ========================================================================
    # PHP Configuration
    # ========================================================================
    
    <FilesMatch \.php$>
        # For Apache 2.4.10+
        SetHandler "proxy:unix:/var/run/php/php8.2-fpm.sock|fcgi://localhost"
        
        # Alternative for mod_php (not recommended for production)
        # SetHandler application/x-httpd-php
    </FilesMatch>
    
    # ========================================================================
    # Security Restrictions
    # ========================================================================
    
    # Deny access to hidden files and directories
    <DirectoryMatch "^\.|\/\.">
        Require all denied
    </DirectoryMatch>
    
    # Deny access to sensitive files
    <FilesMatch "(^\.env|^\.git|composer\.(json|lock)|package(-lock)?\.json|\.editorconfig)$">
        Require all denied
    </FilesMatch>
    
    # Protect Laravel storage directory
    <Directory /var/www/sman1-baleendah/storage>
        <FilesMatch "\.(php|php5|phtml)$">
            Require all denied
        </FilesMatch>
    </Directory>
    
    # ========================================================================
    # Performance Optimization
    # ========================================================================
    
    # Enable HTTP/2
    Protocols h2 http/1.1
    
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml
    </IfModule>
    
    # ========================================================================
    # Logging
    # ========================================================================
    
    ErrorLog ${APACHE_LOG_DIR}/sman1-baleendah-error.log
    CustomLog ${APACHE_LOG_DIR}/sman1-baleendah-access.log combined
    
    # Increase log level for debugging (change to 'warn' in production)
    LogLevel warn
</VirtualHost>

# ============================================================================
# Global Apache Security Settings
# ============================================================================
# Add to /etc/apache2/conf-available/security.conf
# ============================================================================

# ServerTokens Prod
# ServerSignature Off
# TraceEnable Off
# Header always unset X-Powered-By
# Header always unset Server

# ============================================================================
# Required Apache Modules
# ============================================================================
# sudo a2enmod ssl
# sudo a2enmod rewrite
# sudo a2enmod headers
# sudo a2enmod http2
# sudo a2enmod proxy
# sudo a2enmod proxy_fcgi
# sudo a2enmod deflate
# ============================================================================
