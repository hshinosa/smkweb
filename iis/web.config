<?xml version="1.0" encoding="UTF-8"?>
<!--
================================================================================
IIS Configuration for SMAN 1 Baleendah - Production with Cookie Security
================================================================================
Location: C:\inetpub\wwwroot\sman1-baleendah\web.config
================================================================================
-->
<configuration>
    <system.webServer>
        
        <!-- ================================================================ -->
        <!-- URL Rewriting for Laravel -->
        <!-- ================================================================ -->
        <rewrite>
            <rules>
                <!-- Force HTTPS Redirect -->
                <rule name="Force HTTPS" stopProcessing="true">
                    <match url="(.*)" />
                    <conditions>
                        <add input="{HTTPS}" pattern="off" ignoreCase="true" />
                    </conditions>
                    <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
                </rule>
                
                <!-- Laravel Routing -->
                <rule name="Laravel Routes" stopProcessing="true">
                    <match url="^(.*)$" />
                    <conditions logicalGrouping="MatchAll">
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="index.php" />
                </rule>
            </rules>
        </rewrite>
        
        <!-- ================================================================ -->
        <!-- Security Headers -->
        <!-- ================================================================ -->
        <httpProtocol>
            <customHeaders>
                <!-- HSTS -->
                <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains; preload" />
                
                <!-- Content Security Policy -->
                <add name="Content-Security-Policy" value="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self'" />
                
                <!-- XSS Protection -->
                <add name="X-XSS-Protection" value="1; mode=block" />
                
                <!-- Clickjacking Protection -->
                <add name="X-Frame-Options" value="SAMEORIGIN" />
                
                <!-- MIME Type Sniffing Protection -->
                <add name="X-Content-Type-Options" value="nosniff" />
                
                <!-- Referrer Policy -->
                <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
                
                <!-- Permissions Policy -->
                <add name="Permissions-Policy" value="geolocation=(self), microphone=(), camera=()" />
                
                <!-- Remove Server Header -->
                <remove name="Server" />
                <remove name="X-Powered-By" />
            </customHeaders>
        </httpProtocol>
        
        <!-- ================================================================ -->
        <!-- Cookie Security Configuration -->
        <!-- ================================================================ -->
        <httpCookies 
            requireSSL="true" 
            httpOnlyCookies="true" 
            sameSite="Lax" />
        
        <!-- ================================================================ -->
        <!-- Static Content Handling -->
        <!-- ================================================================ -->
        <staticContent>
            <!-- Set MIME types -->
            <remove fileExtension=".woff" />
            <mimeMap fileExtension=".woff" mimeType="font/woff" />
            <remove fileExtension=".woff2" />
            <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
            
            <!-- Client Cache -->
            <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="365.00:00:00" />
        </staticContent>
        
        <!-- ================================================================ -->
        <!-- Compression -->
        <!-- ================================================================ -->
        <urlCompression doStaticCompression="true" doDynamicCompression="true" />
        
        <httpCompression>
            <dynamicTypes>
                <add mimeType="text/*" enabled="true" />
                <add mimeType="message/*" enabled="true" />
                <add mimeType="application/javascript" enabled="true" />
                <add mimeType="application/json" enabled="true" />
                <add mimeType="*/*" enabled="false" />
            </dynamicTypes>
            <staticTypes>
                <add mimeType="text/*" enabled="true" />
                <add mimeType="message/*" enabled="true" />
                <add mimeType="application/javascript" enabled="true" />
                <add mimeType="application/json" enabled="true" />
                <add mimeType="*/*" enabled="false" />
            </staticTypes>
        </httpCompression>
        
        <!-- ================================================================ -->
        <!-- Security Restrictions -->
        <!-- ================================================================ -->
        <security>
            <requestFiltering removeServerHeader="true">
                <!-- Limit request size to 100MB -->
                <requestLimits maxAllowedContentLength="104857600" />
                
                <!-- Hidden segments -->
                <hiddenSegments>
                    <add segment="storage" />
                    <add segment="bootstrap" />
                    <add segment="database" />
                    <add segment=".git" />
                    <add segment=".env" />
                </hiddenSegments>
                
                <!-- File extension restrictions -->
                <fileExtensions>
                    <add fileExtension=".env" allowed="false" />
                    <add fileExtension=".git" allowed="false" />
                    <add fileExtension=".config" allowed="false" />
                </fileExtensions>
            </requestFiltering>
        </security>
        
        <!-- ================================================================ -->
        <!-- Default Document -->
        <!-- ================================================================ -->
        <defaultDocument>
            <files>
                <clear />
                <add value="index.php" />
                <add value="index.html" />
            </files>
        </defaultDocument>
        
        <!-- ================================================================ -->
        <!-- HTTP Errors -->
        <!-- ================================================================ -->
        <httpErrors errorMode="Detailed" existingResponse="PassThrough" />
        
        <!-- ================================================================ -->
        <!-- FastCGI Settings for PHP -->
        <!-- ================================================================ -->
        <handlers>
            <add name="PHP" path="*.php" verb="*" modules="FastCgiModule" 
                 scriptProcessor="C:\PHP\php-cgi.exe" 
                 resourceType="Unspecified" requireAccess="Script" />
        </handlers>
        
    </system.webServer>
    
    <!-- ==================================================================== -->
    <!-- System.Web Configuration (ASP.NET) -->
    <!-- ==================================================================== -->
    <system.web>
        <!-- Session Cookie Security -->
        <sessionState 
            cookieSameSite="Lax" 
            timeout="120" />
        
        <!-- Forms Authentication Cookie Security -->
        <authentication mode="Forms">
            <forms 
                requireSSL="true" 
                cookieSameSite="Lax" 
                protection="All" 
                timeout="120" />
        </authentication>
        
        <!-- Machine Key for Cookie Encryption -->
        <machineKey 
            validationKey="AutoGenerate,IsolateApps" 
            decryptionKey="AutoGenerate,IsolateApps" 
            validation="HMACSHA256" 
            decryption="AES" />
        
        <!-- Compilation -->
        <compilation debug="false" targetFramework="4.8" />
        
        <!-- Custom Errors -->
        <customErrors mode="RemoteOnly" defaultRedirect="~/error" />
        
        <!-- Disable ViewState MAC Validation for PHP apps -->
        <pages enableViewStateMac="false" />
    </system.web>
    
    <!-- ==================================================================== -->
    <!-- Application Settings -->
    <!-- ==================================================================== -->
    <appSettings>
        <add key="ValidationSettings:UnobtrusiveValidationMode" value="None" />
    </appSettings>
    
    <!-- ==================================================================== -->
    <!-- Connection Strings -->
    <!-- ==================================================================== -->
    <connectionStrings>
        <!-- Add your database connection strings here if needed -->
    </connectionStrings>
    
</configuration>

<!--
================================================================================
Additional IIS Configuration via IIS Manager or PowerShell
================================================================================

# Install URL Rewrite Module
Install-PackageProvider -Name NuGet -Force
Install-Module -Name IISAdministration -Force

# Configure SSL/TLS
$siteName = "sman1-baleendah"
$binding = Get-IISSiteBinding -Name $siteName -Protocol https
$binding.Attributes["sslFlags"].Value = "Sni"

# Disable weak protocols
New-Item 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Server' -Force
New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.0\Server' -Name 'Enabled' -Value 0 -PropertyType 'DWord' -Force

New-Item 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Server' -Force
New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.1\Server' -Name 'Enabled' -Value 0 -PropertyType 'DWord' -Force

# Enable TLS 1.2
New-Item 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server' -Force
New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\Server' -Name 'Enabled' -Value 1 -PropertyType 'DWord' -Force

# Enable TLS 1.3
New-Item 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Server' -Force
New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Server' -Name 'Enabled' -Value 1 -PropertyType 'DWord' -Force

# Restart IIS
Restart-Service W3SVC -Force

================================================================================
-->
